<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
    </head>
    <body>
        <h1>Promise All</h1>

        <script>
            const cocurrencyRequest = async (urls, maxNum) => {
                if (urls.length === 0) {
                    return Promise.resolve([]);
                }

                return new Promise((resolve) => {
                    const results = [];
                    let index = 0;
                    let count = 0;

                    async function request() {
                        if (index === urls.length) return;

                        const i = index;
                        const url = urls[index++];

                        try {
                            results[i] = await fetch(url);
                        } finally {
                            if (++count === urls.length) {
                                console.log("FINISHED all request");
                                resolve(results);
                            }
                        }

                        setTimeout(request, 1000);
                    }

                    const times = Math.min(maxNum, urls.length);

                    Array.from({ length: times }, () =>
                        setTimeout(request, 1000)
                    );
                });
            };

            const urls = [];

            for (let i = 1; i <= 21; i++) {
                urls.push(`https://jsonplaceholder.typicode.com/todos/${i}`);
            }

            const result = cocurrencyRequest(urls, 3).then((res) =>
                console.log(res)
            );

            URL.parse(`https://jsonplaceholder.typicode.com/todos/1`);
        </script>
    </body>
</html>
